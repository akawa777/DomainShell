@using DomainShell.Tests.Domain.Models
@model Person[]
@{
    ViewBag.Title = "bulk";
}

@section scripts{
    <script type="text/javascript" src="/scripts/figuram.js"></script>
    <script id="tr-template" type="text/html">
        <td>
            <input class="target" type="checkbox" />
        </td>
        <td class="id"></td>
        <td class="name"></td>
    </script>
    <script type="text/javascript">  
        var tr = {
            template: $("#tr-template").html(),
            ready: function (context, parameters) {
                context(".target").val(parameters.id);
                context(".id a").text(parameters.id);
                context(".name").text(parameters.name);
            }            
        }

        var bulk = {
            ready: function (context) {
                $.get("/person/getall").success(function (persons) {
                    for (var id in persons) {
                        var person = persons[id];

                        var trEl = $("<tr>");
                        context("table tbody").append(trEl);

                        figuram({
                            el: trEl,
                            app: tr,
                            parameters: { id: person.Id, name: person.Name }
                        });
                    }
                }).fail(function (result) {
                    context(".message").html(result.responseText);
                });

                context("[name=save]").on("click", function () {
                    var ids = [];

                    context('.target:checked').map(function () {
                        ids.push($(this).val());
                    });

                    if (ids.length == 0) {
                        context(".message").text("no select target.");
                        return;
                    }

                    var name = context("input[name=name]").val();

                    if (name == "") {
                        context(".message").text("no set name.");
                        return;
                    }

                    $.post("/person/bulkupdate", { ids: ids, name: name }).success(function (result) {
                        if (result.Success) {
                            location.href = "/person";
                        } else {
                            context(".message").text("fail");
                        }
                    }).fail(function (result) {
                        context(".message").html(result.responseText);
                    });
                });

                context(".allTarget").on("click", function () {
                    if ($(this).is(':checked')) {
                        context('.target').map(function () {
                            $(this).prop("checked", true);
                        });
                    } else {
                        context('.target').map(function () {
                            $(this).prop("checked", false);
                        });
                    }
                });
            }
        }

        figuram({
            el: "#app",
            app: bulk
        });
    </script>
}

<h2>bulk</h2>

<div id="app">
    <div class="message"></div>

    <a href="/person">list</a><br />
    <br />
    <form>
        <table>
            <thead>
                <tr>
                    <th><input class="allTarget" type="checkbox" /></th>
                    <th>Id</th>
                    <th>Name</th>
                </tr>
            </thead>
            <tbody>                
            </tbody>
        </table>
        <br />
        <label for="name">name</label>
        <br />
        <input type="text" name="name" />
        <br />
        <br />
        <button name="save" type="button">save</button>
    </form>
</div>

