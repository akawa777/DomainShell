
@{
    ViewBag.Title = "Detail";
    string guid = Guid.NewGuid().ToString();
}

@section scripts {
    <script type="text/javascript">
        require(["coco", "shared/error"], function (coco, error) {
            var appId = "#@guid";

            var detail = {
                node: appId,
                components: {
                    errorName: {
                        model: error
                    }
                },
                ready: function () {
                    var self = this;

                    var isNew = self.$params.isNew;
                    var id = 0;

                    if (isNew) {
                        self.$context(".id").hide();
                        self.$context("[name=remove]").hide();
                    } else {
                        var sections = location.href.split("/");
                        id = sections[sections.length - 1];

                        $.get("/api/person/get", { id: id }).success(function (person) {
                            self.$context(".id").text(person.Id)
                            self.$context("[name=name]").val(person.Name);
                        }).fail(function (result) {
                            $("body").html(result.responseText);
                        });
                    }

                    self.$context("[name=save]").on("click", function () {
                        self.components.errorName.view.clear();

                        var name = self.$context("[name=name]").val();

                        if (name == "") {
                            self.components.errorName.view.message("not set name.");
                            alert("exist error.");
                            return;
                        }

                        $.post(isNew ? "/api/person/add" : "/api/person/update", { id: id, name: name }).success(function (result) {
                            if (result) {
                                if (isNew) {
                                    location.href = "/person";
                                } else {
                                    alert("success.");
                                }
                            } else {
                                alert("failed.");
                            }
                        }).fail(function (result) {
                            $("body").html(result.responseText);
                        });
                    });

                    self.$context("[name=remove]").on("click", function () {
                        self.components.errorName.view.clear();

                        var name = self.$context("[name=name]").val();

                        $.post("/api/person/remove", { id: id, name: name }).success(function (result) {
                            if (result) {
                                location.href = "/person";
                            } else {
                                alert("failed.");
                            }
                        }).fail(function (result) {
                            $("body").html(result.responseText);
                        });
                    });
                }
            }

            var view = coco({
                model: detail,
                params: {
                    isNew: location.href.toLocaleString().indexOf("/person/new") != -1
                }
            });

            $(appId).replaceWith(view.el);
        });
    </script>
}

<div id="@guid">
    <a href="/person">list</a>
    <br />
    <br />

    <form>
        <div>
            <label>
                id: <span class="id"></span>
            </label>
        </div>
        <br />
        <label>
            name: <input type="text" name="name" />
        </label>
        <coco-error-name></coco-error-name>
        <br />
        <br />
        <button name="save" type="button">save</button>
        <button name="remove" type="button">remove</button>
    </form>
</div>
